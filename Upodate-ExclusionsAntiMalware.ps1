
$location = "West US"
$rgname = "CUS-RSG-CLT-PRD"
$vmname1 = "Azr-ema01"
$vmname2 = "GNW-VM-CMS-02"
$vmname3 = "GNW-VM-WEB-1"
$vmname4 = "GNW-VM-WEB-2"
$vmname5 = "GNW-VM-WEB-3"

$allVersions = (Get-AzureRmVMExtensionImage -Location $location -PublisherName "Microsoft.Azure.Security" -Type "IaaSAntimalware").Version
$msavconfig = Get-Content "H:\Azure\iaasantimalware-exclusions-alnisir.json" -raw

$allVersions= (Get-AzureRmVMExtensionImage -Location $location -PublisherName "Microsoft.Azure.Security" -Type "IaaSAntimalware").Version
$typeHandlerVer = $allVersions[($allVersions.count)–1]
$typeHandlerVerMjandMn = $typeHandlerVer.split(".")
$typeHandlerVerMjandMn = $typeHandlerVerMjandMn[0] + "." + $typeHandlerVerMjandMn[1]

#$vms = @($vmname1, $vmname2, $vmname3, $vmname4, $vmname5)

$vms = @($vmname1)

ForEach ($vmn in $vms){
    Set-AzureRmVMExtension -ResourceGroupName $rgname `
        -VMName $vmn `
        -Location $location `
        -name IaaSAntiMalware `
        -Publisher microsoft.azure.security `
        -ExtensionType iaasantimalware `
        -SettingString $msavconfig `
        -TypeHandlerVersion $typeHandlerVerMjandMn    
}




# Remove-AzureRmVMExtension -ResourceGroupName $rgname -VMName $vmname -Name "IaaSAntimalware" 

# Get-AzureRmVMExtension -ResourceGroupName $rgname -VMName $vmname -Name IaaSAntimalware
ForEach ($vmn in $vms){
    Get-AzureRmVMExtension -ResourceGroupName $rgname `
        -VMName $vmn `
        -Name IaaSAntiMalware `
}


<#
# The config file with new exclustions referenced as $msavconfig = Get-Content "H:\Azure\iaasantimalware-exclusions-alnisir.json" -raw  contains the information below.  Use this to update rules and exclusions


{
	"AntimalwareEnabled": true,
	"RealtimeProtectionEnabled": "true",
	"ScheduledScanSettings": {
	"isEnabled": "false",
	"day": "7",
	"time": "120",
	"scanType": "Quick"
  },
  "Exclusions": {
    "Extensions": ".FWD;.GSC;.GSE;.MYD;.MYI;.SMD;.VAC;.BAK;.CHK;.FRM;.LDF;.LOG;.MBX;.MDF;.NDF;.TRN;.UND;.UNF;.UNH;.UNI;.UNQ;.UNS;.VHD;.VMDX;.WCI;.EDB;.SDS",
    "Paths": "C:\\rs-pkgs;C:\\System Volume Information\\DFSR;C:\\Sysvol;C:\\ProgramData\\Microsoft\\SharePoint;C:\\Program Files\\Common Files\\Microsoft Shared\\Web Server Extensions;C:\\Program Files\\Operations Manager;C:\\Program Files\\Microsoft Monitoring Agent;C:\\Program Files\\Microsoft Office Servers;C:\\Program Files\\Microsoft System Center 2012 R2\\Server;C:\\Program Files\\System Center Operations Manager;C:\\Program Files\\System Center Operations Manager 2007;C:\\Windows\\Microsoft.NET\\Framework64\\v2.0.50727\\Temporary ASP.NET Files;C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\Temporary ASP.NET Files\\ \\Windows\\NTDS;C:\\Windows\\System32\\LogFiles;C:\\Windows\\Sysvol;C:\\Program Files\\Double-Take Software;C:\\Program Files\\DoubleTake;C:\\Program Files\\Exchsrvr;C:\\Program Files\\Ipswitch;C:\\Program Files\\LogMeIn;C:\\Windows\\SoftwareDistribution\\Datastore;C:\\Windows\\Temp\\Gthrsvc C:\\Winnt\\Temp\\Gthrsvc\\",
    "Processes": "HealthService.exe;ManagementService.exe;Microsoft.Mom.Sdk.Service.exe;Microsoft.Mom.ConfigServiceHost.exe;MonitoringHost.exe;pagefile.sys"
  }
}

#>