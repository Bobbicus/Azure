#=====================================================================
#SELECT VM
$vm = Get-AzureRmVM | ogv -PassThru

#Get current VM's Anti-Malware configuration
$CurrentAVPublicSettings = (Get-AzureRmVMExtension -ResourceGroupName $vm.ResourceGroupName -VMName $vm.Name -Name "IaaSAntimalware").PublicSettings | ConvertFrom-Json
($CurrentAVPublicSettings.Exclusions.Paths)

#Rebuild anti-malware settings config object
$antimalwareSettingsHash = @{
    "AntimalwareEnabled" = "$($CurrentAVPublicSettings.AntimalwareEnabled)";
    "RealtimeProtectionEnabled" = "$($CurrentAVPublicSettings.RealtimeProtectionEnabled)";
    "Exclusions" = @{
        "Extensions"= "$($CurrentAVPublicSettings.Exclusions.Extensions)";
        "Paths" = "$($CurrentAVPublicSettings.Exclusions.Paths)";
        "Processes" = "$($CurrentAVPublicSettings.Exclusions.Processes)"
    };
    "ScheduledScanSettings" = "$($CurrentAVPublicSettings.ScheduledScanSettings)"
}

#Add new path
$antimalwareSettingsHash.Exclusions.Paths += ";C:\Program Files\Microsoft Azure Recovery Services Agent\Scratch"
$antimalwareSettingsHash.Exclusions.Paths += ";C:\Program Files\Microsoft Azure Recovery Services Agent\bin"

#Get most up to date version of IaaSAntimalware
$allVersions= (Get-AzureRmVMExtensionImage -Location $vm.Location -PublisherName “Microsoft.Azure.Security” -Type “IaaSAntimalware”).Version

$typeHandlerVer = $allVersions[($allVersions.count)–1]
$typeHandlerVerMjandMn = $typeHandlerVer.split(“.”)
$typeHandlerVerMjandMn = $typeHandlerVerMjandMn[0] + “.” + $typeHandlerVerMjandMn[1]

#UPDATE EXTENSION USING NEW CONFIG FILE
Set-AzureRmVMExtension -ResourceGroupName $vm.ResourceGroupName -VMName $vm.Name -Name "IaaSAntimalware" `
    -Publisher "Microsoft.Azure.Security" -ExtensionType "IaaSAntimalware" `
    -Settings $antimalwareSettingsHash -Location $vm.Location -TypeHandlerVersion $typeHandlerVerMjandMn

#Verify new configuration is in place
$UpdatedAVPublicSettings = (Get-AzureRmVMExtension -ResourceGroupName $vm.ResourceGroupName -VMName $vm.Name -Name "IaaSAntimalware").PublicSettings | ConvertFrom-Json
$UpdatedAVPublicSettings | Format-List